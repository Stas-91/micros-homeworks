# Домашнее задание к занятию «Микросервисы: подходы» Помельников Станислав

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

### Решение 1

Для обеспечения процесса разработки, включающего хранение исходного кода, непрерывную интеграцию и поставку (CI/CD), можно использовать следующую комбинацию облачных решений и инструментов:

**GitHub + GitHub Actions + Docker + HashiCorp Vault + Self-hosted Runners**

**Соответствие требованиям:**
| Требование                                              | Решение                                                                                                                                                                  |
| ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Облачная система**                                    | GitHub — облачная платформа                                                                                                                                              |
| **Система контроля версий Git**                         | GitHub использует Git                                                                                                                                                    |
| **Репозиторий на каждый сервис**                        | GitHub позволяет создавать отдельные репозитории                                                                                                                         |
| **Запуск сборки по событию из Git**                     | GitHub Actions поддерживает триггеры по событиям Git (push, pull request и др.)                                                                                          |
| **Запуск сборки по кнопке с параметрами**               | GitHub Actions поддерживает workflow\_dispatch с вводом параметров
| **Привязка настроек к каждой сборке**                   | Возможна через `workflow` файлы с переменными, параметрами и секретами                                                                                                   |
| **Шаблоны конфигураций сборок**                         | GitHub Actions поддерживает Reusable Workflows и Composite Actions                                                                                               |
| **Безопасное хранение секретов**                        | GitHub Secrets или Vault от HashiCorp                                                                                                                                    |
| **Несколько конфигураций сборки из одного репозитория** | Разные workflows или job-матрицы                                                                                                                                         |
| **Кастомные шаги при сборке**                           | Использование bash, Docker, custom actions                                                                                                                               |
| **Собственные Docker-образы**                           | Можно использовать в `jobs` и `runs-on`                                                                                                                                  |
| **Развертывание агентов на своих серверах**             | Self-hosted GitHub Actions runners                                                                                                                                       |
| **Параллельный запуск сборок**                          | Поддерживается — параллельные `jobs` и `matrix`                                                                                                                          |
| **Параллельный запуск тестов**                          | Использование `matrix strategy` или разбиение по `jobs`                                                                                                                  |

**взаимодействия компонентов:**

1. **GitHub (облачный Git)** — каждый сервис имеет свой репозиторий. Хранит исходный код, управляет версиями и правами доступа.
2. **GitHub Actions (CI/CD)**:
   * Сборка запускается при `push`/`PR` или вручную (`workflow_dispatch`).
   * В `yaml`-файлах настраиваются `jobs`, параметры, окружение и секреты.
   * Можно создавать шаблоны workflows (DRY-подход).
   * Поддержка параллельных `jobs`, разделения по матрице и условий выполнения.
3. **Docker**:
   * Использование собственных Docker-образов в сборке.
   * Можно поднимать контейнеры с нужной средой на время сборки.
4. **Self-hosted Runners**:
   * Для масштабируемости, изоляции и ускорения — развёртывание агентов на собственных серверах.
5. **HashiCorp Vault (опционально)**:
   * Для расширенного управления секретами.
   * Интеграция с GitHub Actions через API или консольный клиент.

---

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

### Решение 2

Для обеспечения сбора и анализа логов в микросервисной архитектуре, соответствующего указанным требованиям, предлагаю использовать **ELK-стек (Elasticsearch, Logstash, Kibana)** в сочетании с **Filebeat** от Elastic как лог-агентов на хостах.

**взаимодействия компонентов:**

**1. Log-агенты: Filebeat**

* Устанавливаются на каждый хост, где работают микросервисы.
* Читают логи из stdout (Docker logs, journald, etc.).
* Минимальные требования к самим приложениям: просто логировать в stdout.
* Буферизация и retry-механизмы позволяют гарантировать доставку логов.
* Отправляют логи в Logstash (если требуется предобработка) или напрямую в Elasticsearch.

**2. Logstash (опционально)**

* Выполняет парсинг логов, преобразование форматов, добавление метаданных.
* Гибкая настройка через конфигурационные файлы.
* Поддерживает множество источников и форматов.

**3. Elasticsearch**

* Централизованное хранилище логов.
* Обеспечивает быстрый поиск, фильтрацию, агрегации.
* Высокая масштабируемость и отказоустойчивость.
* Поддержка шардирования, репликации, rollover индексов.

**4. Kibana**

* Веб-интерфейс для работы с логами.
* Предоставляет:

  * Поиск по логам;
  * Сохранённые запросы и дашборды;
  * Возможность дать ссылку на сохранённый поиск;
  * Управление доступом (через Elastic Security или обратные прокси).


**Соответствие требованиям:**
| Требование                               | Решение                                                |
| ---------------------------------------- | ------------------------------------------------------ |
| **Сбор логов со всех хостов**            | Filebeat собирают логи с каждого хоста      |
| **Минимальные требования к приложениям** | Логирование в stdout (Docker logs/journald)            |
| **Гарантированная доставка**             | Буферизация, retry, backpressure в Filebeat |
| **Поиск и фильтрация логов**             | Elasticsearch + Kibana                                 |
| **Пользовательский интерфейс**           | Kibana с разграничением прав                           |
| **Ссылки на сохранённый поиск**          | Kibana позволяет сохранять запросы и делиться ими      |

---


## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

### Решение 3

Для обеспечения эффективного сбора и анализа состояния хостов и сервисов в микросервисной архитектуре предлагаю использовать **стек мониторинга на базе Prometheus, Grafana и node\_exporter / cAdvisor / custom exporters**. Это зрелое, широко применяемое и масштабируемое решение.

**Компоненты решения**

1. **Prometheus**

* **Роль:** Основной инструмент для сбора и хранения метрик.
* **Функции:**

  * Сбор метрик с хостов и сервисов через HTTP endpoints (экспортеры).
  * Поддержка Pull-модели (по умолчанию) или Push через gateway.
  * Язык запросов PromQL для агрегации и анализа данных.

2. **Node Exporter**

* **Роль:** Сбор метрик ОС на каждом хосте.
* **Метрики:** CPU, RAM, HDD, сеть — по хосту.

3. **cAdvisor (Container Advisor)**

* **Роль:** Сбор метрик по контейнерам Docker.
* **Метрики:** CPU, RAM, HDD, сеть — по каждому контейнеру (сервису).
* **Плюсы:** Простая интеграция с Kubernetes и Docker.

4. **Custom Exporters / Instrumentation**

* **Роль:** Сбор бизнес-метрик или специфичных метрик сервиса.
* **Подходы:**

  * Встраивание клиентских библиотек Prometheus (`prometheus-client`) в сервисы.
  * Создание HTTP endpoint `/metrics` в каждом сервисе.

5. **Grafana**

* **Роль:** Визуализация метрик и построение дашбордов.
* **Функции:**

  * Настройка панелей и пользовательских дашбордов.
  * Возможность создавать алерты.
  * Поддержка PromQL.
  * Поддержка ролей и разграничения доступа.
  * Интерактивные панели и фильтры.

**Соответствие требованиям:**
| Требование                                | Описание реализации                                 |
| ----------------------------------------- | --------------------------------------------------- |
| Сбор метрик со всех хостов                | Node Exporter                                       |
| Сбор ресурсов хостов (CPU, RAM, HDD, Net) | Node Exporter                                       |
| Сбор ресурсов по каждому сервису          | cAdvisor (по контейнерам)                           |
| Сбор специфичных метрик                   | Custom Exporters или instrumentation                |
| UI с запросами и агрегацией               | Grafana + PromQL                                    |
| UI с настройкой панелей                   | Grafana (настройка дашбордов, шаблонов, переменных) |


---



## Задача 4: Логи * (необязательная)

Продолжить работу по задаче API Gateway: сервисы, используемые в задаче, пишут логи в stdout. 

Добавить в систему сервисы для сбора логов Vector + ElasticSearch + Kibana со всех сервисов, обеспечивающих работу API.

### Результат выполнения: 

docker compose файл, запустив который можно перейти по адресу http://localhost:8081, по которому доступна Kibana.
Логин в Kibana должен быть admin, пароль qwerty123456.


## Задача 5: Мониторинг * (необязательная)

Продолжить работу по задаче API Gateway: сервисы, используемые в задаче, предоставляют набор метрик в формате prometheus:

- сервис security по адресу /metrics,
- сервис uploader по адресу /metrics,
- сервис storage (minio) по адресу /minio/v2/metrics/cluster.

Добавить в систему сервисы для сбора метрик (Prometheus и Grafana) со всех сервисов, обеспечивающих работу API.
Построить в Graphana dashboard, показывающий распределение запросов по сервисам.

### Результат выполнения: 

docker compose файл, запустив который можно перейти по адресу http://localhost:8081, по которому доступна Grafana с настроенным Dashboard.
Логин в Grafana должен быть admin, пароль qwerty123456.

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
